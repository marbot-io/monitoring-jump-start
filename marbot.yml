---
# Copyright widdix GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: '2010-09-09'
Description: 'marbot.io: AWS basics monitoring (https://github.com/marbot-io/monitoring-jump-start)'
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'marbot endpoint'
      Parameters:
      - EndpointId
      - Stage
      - Test
    - Label:
        default: 'Alerts'
      Parameters:
      - BudgetThreshold
      - SavingsPlansCoverageThreshold
      - SavingsPlansUtilizationThreshold
      - TrustedAdvisor
      - RootUserLogin
      - CloudWatchAlarmFired
      - CloudWatchAlarmOrphaned
      - CloudWatchAlarmAutoClose
      - BatchFailed
      - CodePipelineFailed
      - CodeBuildFailed
      - CodeDeployFailed
      - HealthIssue
      - AutoScalingFailed
      - GuardDutyFinding
      - EMRFailed
      - EBSFailed
      - SSMFailed
      - SSMAutomationFailed
      - SSMConfigurationComplianceFailed
      - SSMCommandFailed
      - SSMStateManagerFailed
      - RDSIssue
      - GlueJobFailed
      - EC2SpotInstanceInterruption
      - ECSServiceFailed
      - ECSDeploymentFailed
      - ECSSpotInterruption
      - MacieFinding
      - SecurityHubFinding
      - SecurityHubInsight
      - OpsWorksDeploymentFailed
      - OpsWorksCommandFailed
      - OpsWorksInstanceFailed
      - OpsWorksAlert
      - ECRImageScanFinding
      - DLMPolicyAlert
      - IoTAnalyticsDatasetAlert
      - ESSoftwareUpdateFailed
      - XRayInsightUpdate
      - BackupFailed
      - AthenaFailed
      - AppFlowFailed
      - EC2FleetFailed
      - ElasticBeanstalkFailed
    - Label:
        default: 'Notifications'
      Parameters:
      - CodePipelineNotifications
      - CodeCommitPullRequestNotifications
      - AMIUpdateNotificationECSOptimized
      - AMIUpdateNotificationAmazonLinux
      - AMIUpdateNotificationAmazonLinux2
      - ACMCertificateApproachingExpiration
      - ESSoftwareUpdateNotifications
      - ApplicationAutoScalingNotifications
      - BackupNotifications
      - ECSDeploymentNotifications
Parameters:
  EndpointId:
    Description: 'Your marbot endpoint ID (to get this value: select a channel where marbot belongs to and send a message like this: "@marbot show me my endpoint id").'
    Type: String
  Stage:
    Description: 'marbot stage (never change this!).'
    Type: String
    Default: v1
    AllowedValues: [v1, dev]
  Test:
    Description: 'Send a single test alert.'
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
  BudgetThreshold:
    Description: 'Receive an alert, if your monthly AWS costs (in USD) are higher than this value (works in us-east-1 only; set to -1 to disable).'
    Type: Number
    Default: -1
    MinValue: -1
  SavingsPlansCoverageThreshold:
    Description: 'Receive an alert, if your monthly Savings Plans coverage (in percents) is lower than this value (works in us-east-1 only; set to -1 to disable).'
    Type: Number
    Default: -1
    MinValue: -1
    MaxValue: 100
  SavingsPlansUtilizationThreshold:
    Description: 'Receive an alert, if your monthly Savings Plans utilization (in percents) is lower than this value (works in us-east-1 only; set to -1 to disable).'
    Type: Number
    Default: -1
    MinValue: -1
    MaxValue: 100
  AMIUpdateNotificationECSOptimized:
    Description: 'Receive a notification, if a new ECS optimized AMI is released (works in us-east-1 only).'
    Type: String
    Default: false
    AllowedValues: [true, false]
  AMIUpdateNotificationAmazonLinux:
    Description: 'Receive a notification, if a new Amazon Linux AMI is released (works in us-east-1 only).'
    Type: String
    Default: false
    AllowedValues: [true, false]
  AMIUpdateNotificationAmazonLinux2:
    Description: 'Receive a notification, if a new Amazon Linux 2 AMI is released (works in us-east-1 only).'
    Type: String
    Default: true
    AllowedValues: [true, false]
  RootUserLogin:
    Description: 'Receive an alert, if a root user login is performed.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CloudWatchAlarmFired:
    Description: 'Receive an alert, if any CloudWatch Alarm fires (state ALARM; instead of defining actions for each alarm).'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CloudWatchAlarmOrphaned:
    Description: 'Receive an alert, if any CloudWatch Alarm does not receive any data (state INSUFFICIENT_DATA; instead of defining actions for each alarm).'
    Type: String
    Default: false
    AllowedValues: [true, false]
  CloudWatchAlarmAutoClose:
    Description: 'Auto-Close an alert, if any CloudWatch Alarm fires (state OK; instead of defining actions for each alarm).'
    Type: String
    Default: false
    AllowedValues: [true, false]
  BatchFailed:
    Description: 'Receive an alert, if any Batch job fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CodePipelineFailed:
    Description: 'Receive an alert, if any CodePipeline execution fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CodePipelineNotifications:
    Description: 'Receive a notification, if a CodePipeline pipeline succeedes.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CodeCommitPullRequestNotifications:
    Description: 'Receive a notification, if a CodeCommit pull request changes.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CodeBuildFailed:
    Description: 'Receive an alert, if any CodeBuild build fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  CodeDeployFailed:
    Description: 'Receive an alert, if any CodeDeploy deployment fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  HealthIssue:
    Description: 'Receive an alert, if AWS is experiencing events that may impact you.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  TrustedAdvisor:
    Description: 'Receive an alert, if any Trusted Advisor check turns red (works in us-east-1 only, requires AWS Business Support or higher).'
    Type: String
    Default: true
    AllowedValues: [true, false]
  AutoScalingFailed:
    Description: 'Receive an alert, if any EC2 instance fails to start or terminate in an Auto Scaling Group.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  GuardDutyFinding:
    Description: 'Receive an alert, if a GuardDuty finding is created.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  EMRFailed:
    Description: 'Receive an alert, if any EMR step or auto scaling policy fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  EBSFailed:
    Description: 'Receive an alert, if any EBS snapshot fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SSMFailed: # should be called SSMMaintenanceWindowFailed, but was not changed for backward compatibility
    Description: 'Receive an alert, if any SSM Maintenance Window execution fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SSMAutomationFailed:
    Description: 'Receive an alert, if any SSM Automation execution fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SSMConfigurationComplianceFailed:
    Description: 'Receive an alert, if any SSM Configuration Compliance check fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SSMCommandFailed:
    Description: 'Receive an alert, if any SSM Command execution fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SSMStateManagerFailed:
    Description: 'Receive an alert, if any SSM State Manager association fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  RDSIssue:
    Description: 'Receive an alert, if any RDS issue is detected.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  GlueJobFailed:
    Description: 'Receive an alert, if any Glue job fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  EC2SpotInstanceInterruption:
    Description: 'Receive a notification, if any EC2 Spot instance is interrupted.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ECSServiceFailed:
    Description: 'Receive an alert, if any ECS service fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ECSDeploymentFailed:
    Description: 'Receive an alert, if any ECS deployment fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ECSSpotInterruption:
    Description: 'Receive an alert, if an ECS Fargate Spot task gets interrupted or fails to launch.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  MacieFinding:
    Description: 'Receive an alert, if Macie generates a new finding.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SecurityHubFinding:
    Description: 'Receive an alert, if a SecurityHub finding is created.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  SecurityHubInsight:
    Description: 'Receive an alert, if a SecurityHub insight is created.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  OpsWorksDeploymentFailed:
    Description: 'Receive an alert, if an OpsWorks deployment fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  OpsWorksCommandFailed:
    Description: 'Receive an alert, if an OpsWorks command fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  OpsWorksInstanceFailed:
    Description: 'Receive an alert, if an OpsWorks instance fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  OpsWorksAlert:
    Description: 'Receive an alert, if OpsWorks fires an alert.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ECRImageScanFinding:
    Description: 'Receive an alert, if a ECR Image Scan finding of severity MEDIUM, HIGH, or CRITICAL is created.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  DLMPolicyAlert:
    Description: 'Receive an alert, if a DLM policy fires an alert.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  IoTAnalyticsDatasetAlert:
    Description: 'Receive an alert, if an IoT Analytics dataset fires an alert.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ACMCertificateApproachingExpiration:
    Description: 'Receive a notification, if an ACM certificate approaches expiration.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ESSoftwareUpdateFailed:
    Description: 'Receive an alert, if an Elasticsearch/OpenSearch software update fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ESSoftwareUpdateNotifications:
    Description: 'Receive notifications about Elasticsearch/OpenSearch software updates.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ApplicationAutoScalingNotifications:
    Description: 'Receive notifications about Application Auto Scaling Scaling Activities.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  XRayInsightUpdate:
    Description: 'Receive an alert, if X-Ray Insight detects a fault.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  BackupFailed:
    Description: 'Receive an alert, if AWS Backup fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  BackupNotifications:
    Description: 'Receive notifications about AWS Backup activities.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  AthenaFailed:
    Description: 'Receive an alert, if Athena fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  AppFlowFailed:
    Description: 'Receive an alert, if AppFlow fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  EC2FleetFailed:
    Description: 'Receive an alert, if EC2 (Spot) Fleet fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ECSDeploymentNotifications:
    Description: 'Receive notifications when AWS deployments succeed.'
    Type: String
    Default: true
    AllowedValues: [true, false]
  ElasticBeanstalkFailed:
    Description: 'Receive an alert, if Elastic Beanstalk fails.'
    Type: String
    Default: true
    AllowedValues: [true, false]
Conditions:
  NorthVirginia: !Equals [!Ref 'AWS::Region', 'us-east-1']
  TestEnabled: !Equals [!Ref Test, 'true']
  # Only available in us-east-1
  BudgetEnabled: !And [!Condition NorthVirginia, !Not [!Equals [!Ref BudgetThreshold, '-1']]]
  SavingsPlansCoverageEnabled: !And [!Condition NorthVirginia, !Not [!Equals [!Ref SavingsPlansCoverageThreshold, '-1']]]
  SavingsPlansUtilizationEnabled: !And [!Condition NorthVirginia, !Not [!Equals [!Ref SavingsPlansUtilizationThreshold, '-1']]]
  AMIUpdateNotificationECSOptimizedEnabled: !And [!Condition NorthVirginia, !Equals [!Ref AMIUpdateNotificationECSOptimized, 'true']]
  AMIUpdateNotificationAmazonLinuxEnabled: !And [!Condition NorthVirginia, !Equals [!Ref AMIUpdateNotificationAmazonLinux, 'true']]
  AMIUpdateNotificationAmazonLinux2Enabled: !And [!Condition NorthVirginia, !Equals [!Ref AMIUpdateNotificationAmazonLinux2, 'true']]
  TrustedAdvisorEnabled: !And [!Condition NorthVirginia, !Equals [!Ref TrustedAdvisor, 'true']]
  # Needs to be created in each region
  RootUserLoginEnabled: !Equals [!Ref RootUserLogin, 'true']
  CloudWatchAlarmFiredEnabled: !Equals [!Ref CloudWatchAlarmFired, 'true']
  CloudWatchAlarmOrphanedEnabled: !Equals [!Ref CloudWatchAlarmOrphaned, 'true']
  CloudWatchAlarmAutoCloseEnabled: !Equals [!Ref CloudWatchAlarmAutoClose, 'true']
  CloudWatchAlarmEnabled: !Or [!Condition CloudWatchAlarmFiredEnabled, !Condition CloudWatchAlarmOrphanedEnabled, !Condition CloudWatchAlarmAutoCloseEnabled]
  BatchFailedEnabled: !Equals [!Ref BatchFailed, 'true']
  CodePipelineFailedEnabled: !Equals [!Ref CodePipelineFailed, 'true']
  CodePipelineNotificationsEnabled: !Equals [!Ref CodePipelineNotifications, 'true']
  CodePipelineNotificationsDisabled: !Not [!Condition CodePipelineNotificationsEnabled]
  CodeCommitPullRequestNotificationsEnabled: !Equals [!Ref CodeCommitPullRequestNotifications, 'true']
  CodeBuildFailedEnabled: !Equals [!Ref CodeBuildFailed, 'true']
  CodeBuildFailedEnabledAndCodePipelineFailedEnabled: !And [!Condition CodeBuildFailedEnabled, !Condition CodePipelineNotificationsEnabled]
  CodeBuildFailedEnabledAndCodePipelineFailedDisabled: !And [!Condition CodeBuildFailedEnabled, !Condition CodePipelineNotificationsDisabled]
  CodeDeployFailedEnabled: !Equals [!Ref CodeDeployFailed, 'true']
  HealthIssueEnabled: !Equals [!Ref HealthIssue, 'true']
  AutoScalingFailedEnabled: !Equals [!Ref AutoScalingFailed, 'true']
  GuardDutyFindingEnabled: !Equals [!Ref GuardDutyFinding, 'true']
  EMRFailedEnabled: !Equals [!Ref EMRFailed, 'true']
  EBSFailedEnabled: !Equals [!Ref EBSFailed, 'true']
  SSMFailedEnabled: !Equals [!Ref SSMFailed, 'true'] # should be called SSMMaintenanceWindowFailedEnabled, but was not changed for backward compatibility
  SSMAutomationFailedEnabled: !Equals [!Ref SSMAutomationFailed, 'true']
  SSMConfigurationComplianceFailedEnabled: !Equals [!Ref SSMConfigurationComplianceFailed, 'true']
  SSMCommandFailedEnabled: !Equals [!Ref SSMCommandFailed, 'true']
  SSMStateManagerFailedEnabled: !Equals [!Ref SSMStateManagerFailed, 'true']
  RDSIssueEnabled: !Equals [!Ref RDSIssue, 'true']
  GlueJobFailedEnabled: !Equals [!Ref GlueJobFailed, 'true']
  EC2SpotInstanceInterruptionEnabled: !Equals [!Ref EC2SpotInstanceInterruption, 'true']
  ECSServiceFailedEnabled: !Equals [!Ref ECSServiceFailed, 'true']
  ECSDeploymentFailedEnabled: !Equals [!Ref ECSDeploymentFailed, 'true']
  ECSSpotInterruptionEnabled: !Equals [!Ref ECSSpotInterruption, 'true']
  MacieFindingEnabled: !Equals [!Ref MacieFinding, 'true']
  SecurityHubFindingEnabled: !Equals [!Ref SecurityHubFinding, 'true']
  SecurityHubInsightEnabled: !Equals [!Ref SecurityHubInsight, 'true']
  OpsWorksDeploymentFailedEnabled: !Equals [!Ref OpsWorksDeploymentFailed, 'true']
  OpsWorksCommandFailedEnabled: !Equals [!Ref OpsWorksCommandFailed, 'true']
  OpsWorksInstanceFailedEnabled: !Equals [!Ref OpsWorksInstanceFailed, 'true']
  OpsWorksAlertEnabled: !Equals [!Ref OpsWorksAlert, 'true']
  ECRImageScanFindingEnabled: !Equals [!Ref ECRImageScanFinding, 'true']
  DLMPolicyAlertEnabled: !Equals [!Ref DLMPolicyAlert, 'true']
  IoTAnalyticsDatasetAlertEnabled: !Equals [!Ref IoTAnalyticsDatasetAlert, 'true']
  ACMCertificateApproachingExpirationEnabled: !Equals [!Ref ACMCertificateApproachingExpiration, 'true']
  ESSoftwareUpdateFailedEnabled: !Equals [!Ref ESSoftwareUpdateFailed, 'true']
  ESSoftwareUpdateNotificationsEnabled: !Equals [!Ref ESSoftwareUpdateNotifications, 'true']
  ApplicationAutoScalingNotificationsEnabled: !Equals [!Ref ApplicationAutoScalingNotifications, 'true']
  XRayInsightUpdateEnabled: !Equals [!Ref XRayInsightUpdate, 'true']
  BackupFailedEnabled: !Equals [!Ref BackupFailed, 'true']
  BackupNotificationsEnabled: !Equals [!Ref BackupNotifications, 'true']
  AthenaFailedEnabled: !Equals [!Ref AthenaFailed, 'true']
  AppFlowFailedEnabled: !Equals [!Ref AppFlowFailed, 'true']
  EC2FleetFailedEnabled: !Equals [!Ref EC2FleetFailed, 'true']
  ECSDeploymentNotificationsEnabled: !Equals [!Ref ECSDeploymentNotifications, 'true']
  ElasticBeanstalkFailedEnabled: !Equals [!Ref ElasticBeanstalkFailed, 'true']
Resources:
  ##########################################################################
  #                                                                        #
  #                                 TOPIC                                  #
  #                                                                        #
  ##########################################################################
  Topic:
    Type: 'AWS::SNS::Topic'
    Properties: {}
  TopicPolicy:
    Type: 'AWS::SNS::TopicPolicy'
    Properties:
      PolicyDocument:
        Id: Id1
        Version: '2012-10-17'
        Statement:
        - Sid: Sid1
          Effect: Allow
          Principal:
            Service:
            - 'events.amazonaws.com' # Allow EventBridge
            - 'budgets.amazonaws.com' # Allow Budget Notifications
            - 'rds.amazonaws.com' # Allow RDS Events
            - 's3.amazonaws.com' # Allow S3 Event Notifications
            - 'backup.amazonaws.com' # Allow Backup Events
            - 'codestar-notifications.amazonaws.com' # Allow CodeStar Notifications
            - 'devops-guru.amazonaws.com' # Allow DevOps Guru Notifications
          Action: 'sns:Publish'
          Resource: !Ref Topic
        - Sid: Sid2
          Effect: Allow
          Principal:
            AWS: '*' # Allow CloudWatch Alarms, ElastiCache Notifications, Elastic Beanstalk Notifications, Auto Scaling Notification
          Action: 'sns:Publish'
          Resource: !Ref Topic
          Condition:
            StringEquals:
              'AWS:SourceOwner': !Ref 'AWS::AccountId'
        - Sid: Sid3
          Effect: Allow
          Principal:
            Service: 'ses.amazonaws.com' # Allow SES Notifications & Events
          Action: 'sns:Publish'
          Resource: !Ref Topic
          Condition:
            StringEquals:
              'AWS:Referer': !Ref 'AWS::AccountId'
      Topics:
      - !Ref Topic
  TopicEndpointSubscription:
    DependsOn: TopicPolicy
    Type: 'AWS::SNS::Subscription'
    Properties:
      DeliveryPolicy:
        healthyRetryPolicy:
          minDelayTarget: 1
          maxDelayTarget: 60
          numRetries: 100
          numNoDelayRetries: 0
          backoffFunction: exponential
        throttlePolicy:
          maxReceivesPerSecond: 1
      Endpoint: !Sub 'https://api.marbot.io/${Stage}/endpoint/${EndpointId}'
      Protocol: https
      TopicArn: !Ref Topic
  MonitoringJumpStartEvent:
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Monitoring Jump Start connection. (created by marbot)'
      ScheduleExpression: 'rate(30 days)'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
        Input: !Sub |
          {
            "Type": "monitoring-jump-start-connection",
            "StackTemplate": "marbot",
            "StackVersion": "3.1.0",
            "Partition": "${AWS::Partition}",
            "AccountId": "${AWS::AccountId}",
            "Region": "${AWS::Region}",
            "StackId": "${AWS::StackId}",
            "StackName": "${AWS::StackName}"
          }
  ##########################################################################
  #                                                                        #
  #                                 ALARMS                                 #
  #                                                                        #
  ##########################################################################
  TrustedAdvisorCostOptimizationAlarm:
    Condition: TrustedAdvisorEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - !Ref Topic
      AlarmDescription: 'Trusted Advisor Cost Optimization checks are red. (created by marbot)'
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Category
        Value: 'Cost Optimization'
      EvaluationPeriods: 1
      MetricName: RedChecks
      Namespace: 'AWS/TrustedAdvisor'
      OKActions:
      - !Ref Topic
      Period: 21600
      Statistic: Maximum
      Threshold: 0
  TrustedAdvisorFaultToleranceAlarm:
    Condition: TrustedAdvisorEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - !Ref Topic
      AlarmDescription: 'Trusted Advisor Fault Tolerance checks are red. (created by marbot)'
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Category
        Value: 'Fault Tolerance'
      EvaluationPeriods: 1
      MetricName: RedChecks
      Namespace: 'AWS/TrustedAdvisor'
      OKActions:
      - !Ref Topic
      Period: 21600
      Statistic: Maximum
      Threshold: 0
  TrustedAdvisorPerformanceAlarm:
    Condition: TrustedAdvisorEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - !Ref Topic
      AlarmDescription: 'Trusted Advisor Performance checks are red. (created by marbot)'
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Category
        Value: 'Performance'
      EvaluationPeriods: 1
      MetricName: RedChecks
      Namespace: 'AWS/TrustedAdvisor'
      OKActions:
      - !Ref Topic
      Period: 21600
      Statistic: Maximum
      Threshold: 0
  TrustedAdvisorSecurityAlarm:
    Condition: TrustedAdvisorEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - !Ref Topic
      AlarmDescription: 'Trusted Advisor Security checks are red. (created by marbot)'
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Category
        Value: 'Security'
      EvaluationPeriods: 1
      MetricName: RedChecks
      Namespace: 'AWS/TrustedAdvisor'
      OKActions:
      - !Ref Topic
      Period: 21600
      Statistic: Maximum
      Threshold: 0
  TrustedAdvisorServiceLimitsAlarm:
    Condition: TrustedAdvisorEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - !Ref Topic
      AlarmDescription: 'Trusted Advisor Service Limits checks are red. (created by marbot)'
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Category
        Value: 'Service Limits'
      EvaluationPeriods: 1
      MetricName: RedChecks
      Namespace: 'AWS/TrustedAdvisor'
      OKActions:
      - !Ref Topic
      Period: 21600
      Statistic: Maximum
      Threshold: 0
  ##########################################################################
  #                                                                        #
  #                              SUBSCRIPTIONS                             #
  #                                                                        #
  ##########################################################################
  AMIUpdateNotificationECSOptimizedSubscription:
    Condition: AMIUpdateNotificationECSOptimizedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::SNS::Subscription'
    Properties:
      DeliveryPolicy:
        healthyRetryPolicy:
          minDelayTarget: 1
          maxDelayTarget: 60
          numRetries: 100
          numNoDelayRetries: 0
          backoffFunction: exponential
        throttlePolicy:
          maxReceivesPerSecond: 1
      Endpoint: !Sub 'https://api.marbot.io/${Stage}/endpoint/${EndpointId}'
      Protocol: https
      TopicArn: 'arn:aws:sns:us-east-1:177427601217:ecs-optimized-amazon-ami-update'
  AMIUpdateNotificationAmazonLinuxSubscription:
    Condition: AMIUpdateNotificationAmazonLinuxEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::SNS::Subscription'
    Properties:
      DeliveryPolicy:
        healthyRetryPolicy:
          minDelayTarget: 1
          maxDelayTarget: 60
          numRetries: 100
          numNoDelayRetries: 0
          backoffFunction: exponential
        throttlePolicy:
          maxReceivesPerSecond: 1
      Endpoint: !Sub 'https://api.marbot.io/${Stage}/endpoint/${EndpointId}'
      Protocol: https
      TopicArn: 'arn:aws:sns:us-east-1:137112412989:amazon-linux-ami-updates'
  AMIUpdateNotificationAmazonLinux2Subscription:
    Condition: AMIUpdateNotificationAmazonLinux2Enabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::SNS::Subscription'
    Properties:
      DeliveryPolicy:
        healthyRetryPolicy:
          minDelayTarget: 1
          maxDelayTarget: 60
          numRetries: 100
          numNoDelayRetries: 0
          backoffFunction: exponential
        throttlePolicy:
          maxReceivesPerSecond: 1
      Endpoint: !Sub 'https://api.marbot.io/${Stage}/endpoint/${EndpointId}'
      Protocol: https
      TopicArn: 'arn:aws:sns:us-east-1:137112412989:amazon-linux-2-ami-updates'
  ##########################################################################
  #                                                                        #
  #                                 BUDGET                                 #
  #                                                                        #
  ##########################################################################
  Budget:
    Condition: BudgetEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Budgets::Budget'
    Properties:
      NotificationsWithSubscribers:
      - Subscribers:
        - SubscriptionType: SNS
          Address: !Ref Topic
        Notification:
          ComparisonOperator: 'GREATER_THAN'
          NotificationType: ACTUAL
          Threshold: 100
          ThresholdType: PERCENTAGE
      - Subscribers:
        - SubscriptionType: SNS
          Address: !Ref Topic
        Notification:
          ComparisonOperator: 'GREATER_THAN'
          NotificationType: FORECASTED
          Threshold: 100
          ThresholdType: PERCENTAGE
      Budget:
        BudgetLimit:
          Amount: !Ref BudgetThreshold
          Unit: USD
        TimeUnit: MONTHLY
        CostTypes:
          IncludeSupport: false
          IncludeOtherSubscription: false
          IncludeTax: false
          IncludeSubscription: true
          IncludeUpfront: false
          IncludeDiscount: true
          IncludeCredit: false
          IncludeRecurring: false
          UseAmortized: false
          IncludeRefund: false
          UseBlended: false
        BudgetType: COST
  SavingsPlansCoverage:
    Condition: SavingsPlansCoverageEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Budgets::Budget'
    Properties:
      NotificationsWithSubscribers:
      - Subscribers:
        - SubscriptionType: SNS
          Address: !Ref Topic
        Notification:
          ComparisonOperator: 'LESS_THAN'
          NotificationType: ACTUAL
          Threshold: !Ref SavingsPlansCoverageThreshold
          ThresholdType: PERCENTAGE
      Budget:
        TimeUnit: MONTHLY
        BudgetType: SAVINGS_PLANS_COVERAGE
  SavingsPlansUtilization:
    Condition: SavingsPlansUtilizationEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Budgets::Budget'
    Properties:
      NotificationsWithSubscribers:
      - Subscribers:
        - SubscriptionType: SNS
          Address: !Ref Topic
        Notification:
          ComparisonOperator: 'LESS_THAN'
          NotificationType: ACTUAL
          Threshold: !Ref SavingsPlansUtilizationThreshold
          ThresholdType: PERCENTAGE
      Budget:
        TimeUnit: MONTHLY
        BudgetType: SAVINGS_PLANS_UTILIZATION
  ##########################################################################
  #                                                                        #
  #                                 EVENTS                                 #
  #                                                                        #
  ##########################################################################
  RootUserLoginEvent:
    Condition: RootUserLoginEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A root user login was detected, better use IAM users instead. (created by marbot)'
      EventPattern:
        'detail-type':
        - 'AWS Console Sign In via CloudTrail'
        detail:
          userIdentity:
            arn:
            - !Sub 'arn:aws:iam::${AWS::AccountId}:root'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CloudWatchAlarmFilterRole:
    Condition: CloudWatchAlarmEnabled
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'lambda.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: filter
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: 'cloudwatch:describeAlarms'
            Resource: '*'
          - Effect: Allow
            Action: 'sns:Publish'
            Resource: !Ref Topic
  CloudWatchAlarmFilterPolicy:
    Condition: CloudWatchAlarmEnabled
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - 'logs:CreateLogStream'
          - 'logs:PutLogEvents'
          Resource: !GetAtt 'CloudWatchAlarmFilterLogGroup.Arn'
      PolicyName: lambda
      Roles:
      - !Ref CloudWatchAlarmFilterRole
  CloudWatchAlarmFilterFunction: # Filter out alarms to trigger autoscaling actions
    Condition: CloudWatchAlarmEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Lambda::Function'
    Properties:
      Handler: 'index.handler'
      Runtime: 'nodejs16.x'
      MemorySize: 1024
      Timeout: 30
      Role: !GetAtt 'CloudWatchAlarmFilterRole.Arn'
      Environment:
        Variables:
          TOPIC_ARN: !Ref Topic
      Code:
        ZipFile: |
          'use strict';
          const AWS = require('aws-sdk')
          const cloudwatch = new AWS.CloudWatch({apiVersion: '2010-08-01'});
          const sns = new AWS.SNS({apiVersion: '2010-03-31'});
          const STATE2ACTION = {
            'ALARM': 'AlarmActions',
            'OK': 'OKActions',
            'INSUFFICIENT_DATA':  'InsufficientDataActions'
          };
          exports.handler = async (event) => {
            console.log(JSON.stringify(event));
            const data = await cloudwatch.describeAlarms({
              AlarmNames: [event.detail.alarmName],
              MaxRecords: 1
            }).promise();
            const alarms = [...data.CompositeAlarms, ...data.MetricAlarms];
            console.log(JSON.stringify(alarms));
            if (alarms.length === 0) {
              return;
            } else {
              const alarm = alarms[0];
              const action = STATE2ACTION[event.detail.state.value];
              const actions = alarm[action];
              console.log(JSON.stringify(actions));
              if (alarm.ActionsEnabled) {
                if (actions.filter(action => action.includes(':autoscaling:')).length > 0) {
                  console.log("drop");
                } else {
                  console.log("publish");
                  await sns.publish({
                    TopicArn: process.env.TOPIC_ARN,
                    Message: JSON.stringify(event)
                  }).promise();
                }
              }
            }
          };
  CloudWatchAlarmFilterAlarmErrorsTooHigh:
    Condition: CloudWatchAlarmEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Invocations failed due to errors in the function'
      Namespace: 'AWS/Lambda'
      MetricName: Errors
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - !Ref Topic
      Dimensions:
      - Name: FunctionName
        Value: !Ref CloudWatchAlarmFilterFunction
  CloudWatchAlarmFilterAlarmThrottlesTooHigh:
    Condition: CloudWatchAlarmEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Invocation attempts that were throttled due to invocation rates exceeding the concurrent limits'
      Namespace: 'AWS/Lambda'
      MetricName: Throttles
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - !Ref Topic
      Dimensions:
      - Name: FunctionName
        Value: !Ref CloudWatchAlarmFilterFunction
  CloudWatchAlarmFilterLogGroup:
    Condition: CloudWatchAlarmEnabled
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '/aws/lambda/${CloudWatchAlarmFilterFunction}'
      RetentionInDays: 14
  CloudWatchAlarmFilterPermissionFiredEvent:
    Condition: CloudWatchAlarmFiredEnabled
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref CloudWatchAlarmFilterFunction
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt 'CloudWatchAlarmFiredEvent.Arn'
  CloudWatchAlarmFilterPermissionAlarmAutoCloseEvent:
    Condition: CloudWatchAlarmAutoCloseEnabled
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref CloudWatchAlarmFilterFunction
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt 'CloudWatchAlarmAutoCloseEvent.Arn'
  CloudWatchAlarmFilterPermissionOrphanedEvent:
    Condition: CloudWatchAlarmOrphanedEnabled
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref CloudWatchAlarmFilterFunction
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt 'CloudWatchAlarmOrphanedEvent.Arn'
  CloudWatchAlarmFiredEvent:
    Condition: CloudWatchAlarmFiredEnabled
    DependsOn: CloudWatchAlarmFilterPolicy
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CloudWatch Alarm fired. (created by marbot)'
      EventPattern:
        source:
        - 'aws.cloudwatch'
        'detail-type':
        - 'CloudWatch Alarm State Change'
        detail:
          state:
            value:
            - ALARM
      State: ENABLED
      Targets:
      - Arn: !GetAtt 'CloudWatchAlarmFilterFunction.Arn'
        Id: marbot
  CloudWatchAlarmOrphanedEvent:
    Condition: CloudWatchAlarmOrphanedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CloudWatch Alarm orphaned. (created by marbot)'
      EventPattern:
        source:
        - 'aws.cloudwatch'
        'detail-type':
        - 'CloudWatch Alarm State Change'
        detail:
          state:
            value:
            - INSUFFICIENT_DATA
      State: ENABLED
      Targets:
      - Arn: !GetAtt 'CloudWatchAlarmFilterFunction.Arn'
        Id: marbot
  CloudWatchAlarmAutoCloseEvent:
    Condition: CloudWatchAlarmAutoCloseEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CloudWatch Alarm could be auto-closed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.cloudwatch'
        'detail-type':
        - 'CloudWatch Alarm State Change'
        detail:
          state:
            value:
            - OK
      State: ENABLED
      Targets:
      - Arn: !GetAtt 'CloudWatchAlarmFilterFunction.Arn'
        Id: marbot
  BatchFailedEvent:
    Condition: BatchFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A Batch job failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.batch'
        'detail-type':
        - 'Batch Job State Change'
        detail:
          status:
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodePipelineFailedEvent:
    Condition: CodePipelineFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CodePipeline execution failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codepipeline'
        'detail-type':
        - 'CodePipeline Pipeline Execution State Change'
        detail:
          state:
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodePipelineNotificationsEvent:
    Condition: CodePipelineNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'CodePipeline notifications. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codepipeline'
        'detail-type':
        - 'CodePipeline Pipeline Execution State Change'
        detail:
          state:
          - SUCCEEDED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodeCommitPullRequestNotificationsEvent:
    Condition: CodeCommitPullRequestNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'CodeCommit pull request notifications. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codecommit'
        'detail-type':
        - 'CodeCommit Pull Request State Change'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodeBuildFailedWithoutInitiatorCodePipelineEvent:
    Condition: CodeBuildFailedEnabledAndCodePipelineFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CodeBuild build failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codebuild'
        'detail-type':
        - 'CodeBuild Build State Change'
        detail:
          'build-status':
          - FAILED
          'additional-information':
            initiator: [{'anything-but': {'prefix': 'codepipeline/'}}]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodeBuildFailedEvent:
    Condition: CodeBuildFailedEnabledAndCodePipelineFailedDisabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CodeBuild build failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codebuild'
        'detail-type':
        - 'CodeBuild Build State Change'
        detail:
          'build-status':
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  CodeDeployFailedEvent:
    Condition: CodeDeployFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'A CodeDeploy deployment or instance failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.codedeploy'
        'detail-type':
        - 'CodeDeploy Deployment State-change Notification'
        - 'CodeDeploy Instance State-change Notification'
        detail:
          state:
          - FAILURE
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  HealthIssueEvent:
    Condition: HealthIssueEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'AWS is experiencing events that may impact you. (created by marbot)'
      EventPattern:
        source:
        - 'aws.health'
        'detail-type':
        - 'AWS Health Event'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  AutoScalingFailedEvent:
    Condition: AutoScalingFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EC2 Instances controlled by an Auto Scaling Group failed to launch or terminate. (created by marbot)'
      EventPattern:
        source:
        - 'aws.autoscaling'
        'detail-type':
        - 'EC2 Instance Launch Unsuccessful'
        - 'EC2 Instance Terminate Unsuccessful'
        - 'EC2 Auto Scaling Instance Refresh Failed'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  GuardDutyFindingEvent:
    Condition: GuardDutyFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Findings (severity >= high) from AWS GuardDuty. (created by marbot)'
      EventPattern:
        source:
        - 'aws.guardduty'
        'detail-type':
        - 'GuardDuty Finding'
        detail:
          severity: [{numeric: ['>=', 7]}]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  EMRFailedEvent:
    Condition: EMRFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EMR step or auto scaling policy failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.emr'
        'detail-type':
        - 'EMR Auto Scaling Policy State Change'
        - 'EMR Step Status Change'
        detail:
          state:
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  EBSFailedEvent:
    Condition: EBSFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EBS snapshot failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ec2'
        'detail-type':
        - 'EBS Snapshot Notification'
        - 'EBS Multi-Volume Snapshots Completion Status'
        detail:
          result:
          - failed
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SSMFailedEvent: # should be called SSMMaintenanceWindowFailedEvent, but was not changed for backward compatibility
    Condition: SSMFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'SSM Maintenance Window execution failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ssm'
        'detail-type':
        - 'Maintenance Window Execution State-change Notification'
        detail:
          status:
          - FAILED
          - TIMED_OUT
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SSMAutomationFailedEvent:
    Condition: SSMAutomationFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'SSM Automation execution failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ssm'
        'detail-type':
        - 'EC2 Automation Execution Status-change Notification'
        detail:
          status:
          - Failed
          - TimedOut
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SSMConfigurationComplianceFailedEvent:
    Condition: SSMConfigurationComplianceFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'SSM Configuration Compliance check failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ssm'
        'detail-type':
        - 'Configuration Compliance State Change'
        detail:
          'compliance-status':
          - non_compliant
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SSMCommandFailedEvent:
    Condition: SSMCommandFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'SSM Command execution failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ssm'
        'detail-type':
        - 'EC2 Command Status-change Notification'
        detail:
          status:
          - 'Delivery Timed Out'
          - 'Execution Timed Out'
          - Failed
          - Incomplete
          - 'Rate Exceeded'
          - 'Access Denied'
          - 'No Instances In Tag'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SSMStateManagerFailedEvent:
    Condition: SSMStateManagerFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'SSM State Manager association failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ssm'
        'detail-type':
        - 'EC2 State Manager Association State Change'
        detail:
          status:
          - Failed
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  RDSInstanceIssue:
    Condition: RDSIssueEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::RDS::EventSubscription'
    Properties:
      SnsTopicArn: !Ref Topic
      SourceType: 'db-instance'
  RDSClusterIssue:
    Condition: RDSIssueEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::RDS::EventSubscription'
    Properties:
      SnsTopicArn: !Ref Topic
      SourceType: 'db-cluster'
  GlueJobFailedEvent:
    Condition: GlueJobFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Glue job failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.glue'
        'detail-type':
        - 'Glue Job State Change'
        detail:
          'state':
          - FAILED
          - TIMEOUT
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  EC2SpotInstanceInterruptionEvent:
    Condition: EC2SpotInstanceInterruptionEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EC2 Spot Instance interrupted. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ec2'
        'detail-type':
        - 'EC2 Spot Instance Interruption Warning'
        - 'EC2 Instance Rebalance Recommendation'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECSServiceFailedEvent:
    Condition: ECSServiceFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'ECS Service failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecs'
        'detail-type':
        - 'ECS Service Action'
        detail:
          eventType:
          - ERROR
          - WARN
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECSDeploymentFailedEvent:
    Condition: ECSDeploymentFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'ECS Deployment failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecs'
        'detail-type':
        - 'ECS Deployment State Change'
        detail:
          eventName:
          - SERVICE_DEPLOYMENT_FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECSDeploymentNotificationsEvent:
    Condition: ECSDeploymentNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'ECS Service deployment succeeded. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecs'
        'detail-type':
        - 'ECS Deployment State Change'
        detail:
          eventName:
          - SERVICE_DEPLOYMENT_COMPLETED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECSSpotPlacementFailureEvent:
    Condition: ECSSpotInterruptionEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'ECS service scheduler was unable to acquire any Fargate Spot capacity. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecs'
        'detail-type':
        - 'ECS Service Action'
        detail:
          eventName:
          - SERVICE_TASK_PLACEMENT_FAILURE
          reason:
          - 'RESOURCE:FARGATE'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECSSpotInterruptionEvent:
    Condition: ECSSpotInterruptionEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'ECS task is stopping due to Fargate Spot interruption. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecs'
        'detail-type':
        - 'ECS Task State Change'
        detail:
          stopCode:
          - TerminationNotice
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  MacieFindingEvent:
    Condition: MacieFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Findings (severity >= high) from AWS Macie. (created by marbot)'
      EventPattern:
        source:
        - 'aws.macie'
        'detail-type':
        - 'Macie Finding'
        detail:
          severity:
            score: [{numeric: ['>=', 3]}]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  SecurityHubWorkflowRole:
    Condition: SecurityHubFindingEnabled
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'lambda.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: workflow
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: 'securityhub:BatchUpdateFindings'
            Resource: '*'
  SecurityHubWorkflowPolicy:
    Condition: SecurityHubFindingEnabled
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - 'logs:CreateLogStream'
          - 'logs:PutLogEvents'
          Resource: !GetAtt 'SecurityHubWorkflowLogGroup.Arn'
      PolicyName: lambda
      Roles:
      - !Ref SecurityHubWorkflowRole
  SecurityHubWorkflowFunction: # Set workflow status to notified
    Condition: SecurityHubFindingEnabled
    Type: 'AWS::Lambda::Function'
    Properties:
      Handler: 'index.handler'
      Runtime: 'nodejs16.x'
      MemorySize: 1024
      Timeout: 30
      Role: !GetAtt 'SecurityHubWorkflowRole.Arn'
      Code:
        ZipFile: |
          'use strict';
          const AWS = require('aws-sdk')
          const securityhub = new AWS.SecurityHub({apiVersion: '2018-10-26'});
          exports.handler = async (event) => {
            console.log(JSON.stringify(event));
            await securityhub.batchUpdateFindings({
              FindingIdentifiers: event.detail.findings.map((finding) => ({
                Id: finding.Id,
                ProductArn: finding.ProductArn
              })),
              Workflow: {
                Status: 'NOTIFIED'
              }
            }).promise();
          };
  SecurityHubWorkflowAlarmErrorsTooHigh:
    Condition: SecurityHubFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Invocations failed due to errors in the function'
      Namespace: 'AWS/Lambda'
      MetricName: Errors
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - !Ref Topic
      Dimensions:
      - Name: FunctionName
        Value: !Ref SecurityHubWorkflowFunction
  SecurityHubWorkflowAlarmThrottlesTooHigh:
    Condition: SecurityHubFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Invocation attempts that were throttled due to invocation rates exceeding the concurrent limits'
      Namespace: 'AWS/Lambda'
      MetricName: Throttles
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - !Ref Topic
      Dimensions:
      - Name: FunctionName
        Value: !Ref SecurityHubWorkflowFunction
  SecurityHubWorkflowLogGroup:
    Condition: SecurityHubFindingEnabled
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '/aws/lambda/${SecurityHubWorkflowFunction}'
      RetentionInDays: 14
  SecurityHubWorkflowPermissionFindingEvent:
    Condition: SecurityHubFindingEnabled
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref SecurityHubWorkflowFunction
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt 'SecurityHubFindingEvent.Arn'
  SecurityHubFindingEvent:
    Condition: SecurityHubFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Findings (severity >= high) from AWS SecurityHub. (created by marbot)'
      EventPattern:
        source:
        - 'aws.securityhub'
        'detail-type':
        - 'Security Hub Findings - Imported'
        detail:
          findings:
            Severity:
              Normalized: [{numeric: ['>=', 70]}]
            Workflow:
              Status:
              - NEW
            RecordState:
            - ACTIVE
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
      - Arn: !GetAtt 'SecurityHubWorkflowFunction.Arn'
        Id: marbot-securityhub
  SecurityHubInsightEvent:
    Condition: SecurityHubInsightEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Insights from AWS SecurityHub. (created by marbot)'
      EventPattern:
        source:
        - 'aws.securityhub'
        'detail-type':
        - 'Security Hub Insight Results'
        detail:
          'number of results': [{numeric: ['>=', 1]}]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  OpsWorksDeploymentFailedEvent:
    Condition: OpsWorksDeploymentFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'An OpsWorks deployment failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.opsworks'
        'detail-type':
        - 'OpsWorks Deployment State Change'
        detail:
          status:
          - failed
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  OpsWorksCommandFailedEvent:
    Condition: OpsWorksCommandFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'An OpsWorks command failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.opsworks'
        'detail-type':
        - 'OpsWorks Command State Change'
        detail:
          status:
          - failed
          - expired
          - skipped
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  OpsWorksInstanceFailedEvent:
    Condition: OpsWorksInstanceFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'An OpsWorks instance failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.opsworks'
        'detail-type':
        - 'OpsWorks Instance State Change'
        detail:
          status:
          - 'connection_lost'
          - 'setup_failed'
          - 'start_failed'
          - 'stop_failed'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  OpsWorksAlertEvent:
    Condition: OpsWorksAlertEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Alerts from AWS OpsWorks. (created by marbot)'
      EventPattern:
        source:
        - 'aws.opsworks'
        'detail-type':
        - 'OpsWorks Alert'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ECRImageScanFindingEvent:
    Condition: ECRImageScanFindingEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Findings from AWS ECR Image Scans. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ecr'
        'detail-type':
        - 'ECR Image Scan'
        detail:
          finding-severity-counts:
            CRITICAL: [{exists: false}, {numeric: ['>', 0]}]
            HIGH: [{exists: false}, {numeric: ['>', 0]}]
            MEDIUM: [{exists: false}, {numeric: ['>', 0]}]
            UNDEFINED: [{exists: false}, {numeric: ['>', 0]}]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  DLMPolicyAlertEvent:
    Condition: DLMPolicyAlertEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Alerts from Amazon Data Lifecycle Manager. (created by marbot)'
      EventPattern:
        source:
        - 'aws.dlm'
        'detail-type':
        - 'DLM Policy State Change'
        detail:
          state:
          - ERROR
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  IoTAnalyticsDatasetAlertEvent:
    Condition: IoTAnalyticsDatasetAlertEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Alerts from IoT Analytics dataset. (created by marbot)'
      EventPattern:
        source:
        - 'aws.iotanalytics'
        'detail-type':
        - 'IoT Analytics Dataset Lifecycle Notification'
        detail:
          state:
          - CONTENT_DELIVERY_FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ACMCertificateApproachingExpirationEvent:
    Condition: ACMCertificateApproachingExpirationEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Approaching expiration from ACM Certificate. (created by marbot)'
      EventPattern:
        source:
        - 'aws.acm'
        'detail-type':
        - 'ACM Certificate Approaching Expiration'
        detail:
          DaysToExpiry: [1, 2, 3, 7, 14, 21, 28, 35, 42, 49, 56, 63, 70]
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ESSoftwareUpdateFailedEvent:
    Condition: ESSoftwareUpdateFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Alerts from Elasticsearch/OpenSearch software updates. (created by marbot)'
      EventPattern:
        source:
        - 'aws.es'
        'detail-type':
        - 'Amazon ES Service Software Update Notification'
        - 'Amazon OpenSearch Service Software Update Notification'
        detail:
          status:
          - Failed
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ESSoftwareUpdateNotificationsEvent:
    Condition: ESSoftwareUpdateNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Notifications from Elasticsearch/OpenSearch software updates. (created by marbot)'
      EventPattern:
        source:
        - 'aws.es'
        'detail-type':
        - 'Amazon ES Service Software Update Notification'
        - 'Amazon OpenSearch Service Software Update Notification'
        detail:
          status:
          - Available
          - Completed
          - Required
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ApplicationAutoScalingNotificationsEvent:
    Condition: ApplicationAutoScalingNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Notifications from Application Auto Scaling. (created by marbot)'
      EventPattern:
        source:
        - 'aws.application-autoscaling'
        'detail-type':
        - 'Application Auto Scaling Scaling Activity State Change'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  XRayInsightUpdateEvent:
    Condition: XRayInsightUpdateEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'X-Ray Insight fault detected. (created by marbot)'
      EventPattern:
        source:
        - 'aws.xray'
        'detail-type':
        - 'AWS X-Ray Insight Update'
        detail:
          State:
          - ACTIVE
          Categories:
          - FAULT
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  BackupFailedEvent:
    Condition: BackupFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'AWS Backup failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.backup'
        'detail-type':
        - 'Backup Job State Change'
        - 'Copy Job State Change'
        - 'Restore Job State Change'
        detail:
          state:
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  BackupNotificationsEvent:
    Condition: BackupNotificationsEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Notifications from AWS Backup. (created by marbot)'
      EventPattern:
        source:
        - 'aws.backup'
        'detail-type':
        - 'Backup Job State Change'
        - 'Copy Job State Change'
        - 'Restore Job State Change'
        detail:
          state:
          - COMPLETED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  AthenaFailedEvent:
    Condition: AthenaFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Athena failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.athena'
        'detail-type':
        - 'Athena Query State Change'
        detail:
          currentState:
          - FAILED
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  AppFlowFailedEvent:
    Condition: AppFlowFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'AppFlow failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.appflow'
        'detail-type':
        - 'AppFlow End Flow Run Report'
        detail:
          status:
          - 'Execution Failed'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  AppFlowDeactivatedEvent:
    Condition: AppFlowFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'AppFlow deactivated. (created by marbot)'
      EventPattern:
        source:
        - 'aws.appflow'
        'detail-type':
        - 'AppFlow Event Flow Deactivated'
        - 'AppFlow Scheduled Flow Deactivated'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  EC2FleetFailedEvent:
    Condition: EC2FleetFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EC2 Fleet failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ec2fleet'
        'detail-type':
        - 'EC2 Fleet Error'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  EC2SpotFleetFailedEvent:
    Condition: EC2FleetFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'EC2 Spot Fleet failed. (created by marbot)'
      EventPattern:
        source:
        - 'aws.ec2spotfleet'
        'detail-type':
        - 'EC2 Spot Fleet Error'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ElasticBeanstalkFailedEvent:
    Condition: ElasticBeanstalkFailedEnabled
    DependsOn: TopicEndpointSubscription
    Type: 'AWS::Events::Rule'
    Properties:
      Description: 'Elastic Beanstalk notifications. (created by marbot)'
      EventPattern:
        source:
        - 'aws.elasticbeanstalk'
        detail-type:
        - 'Elastic Beanstalk resource status change'
        - 'Other resource status change'
        - 'Health status change'
        - 'ManagedUpdateStatusChangeEnabled'
        detail:
          Severity:
          - 'WARN'
          - 'ERROR'
      State: ENABLED
      Targets:
      - Arn: !Ref Topic
        Id: marbot
  ##########################################################################
  #                                                                        #
  #                                  TEST                                  #
  #                                                                        #
  ##########################################################################
  TestAlert:
    Condition: TestEnabled
    Type: 'Custom::Test'
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'TestAlertFunction.Arn'
      EndpointId: !Ref EndpointId
      Stage: !Ref Stage
      AccountId: !Ref 'AWS::AccountId'
      Region: !Ref 'AWS::Region'
  TestAlertFunctionLogGroup:
    Condition: TestEnabled
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}'
      RetentionInDays: 14
  TestAlertFunction: # needs no monitoring because it is used as a custom resource
    Condition: TestEnabled
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        ZipFile: |
          'use strict';
          const https = require('https');
          const querystring = require('querystring');
          const response = require('cfn-response');
          exports.handler = (event, context, cb) => {
            console.log(JSON.stringify(event));
            if (event.RequestType === 'Create' || event.RequestType === 'Update') {
              const alert = {
                AccountId: event.ResourceProperties.AccountId,
                Region: event.ResourceProperties.Region,
                Message: 'Test alert'
              };
              const req = https.request({
                hostname: 'api.marbot.io',
                path: `/${event.ResourceProperties.Stage}/endpoint/${event.ResourceProperties.EndpointId}?${querystring.stringify(alert)}`,
                method: 'GET'
              }, (res) => {
                res.on('data', () => {});
                res.on('end', () => {
                  if (res.statusCode === 204) {
                    response.send(event, context, response.SUCCESS, {});
                  } else {
                    console.log(`unexpected status code ${res.statusCode}`);
                    response.send(event, context, response.FAILED, {});
                  }
                });
              });
              req.on('error', (e) => {
                console.log(JSON.stringify(err));
                response.send(event, context, response.FAILED, {});
              });
              req.end();
            } else {
              response.send(event, context, response.SUCCESS, {});
            }
          };
      FunctionName: !Ref 'AWS::StackName'
      Handler: 'index.handler'
      MemorySize: 128
      Role: !GetAtt 'TestAlertFunctionRole.Arn'
      Runtime: 'nodejs16.x'
      Timeout: 30
  TestAlertFunctionRole:
    Condition: TestEnabled
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'lambda.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: 'lambda'
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - 'logs:CreateLogStream'
            - 'logs:PutLogEvents'
            Resource: !GetAtt 'TestAlertFunctionLogGroup.Arn'
Outputs:
  StackName:
    Description: 'Stack name.'
    Value: !Sub '${AWS::StackName}'
  StackTemplate:
    Description: 'Stack template.'
    Value: 'marbot'
  StackVersion:
    Description: 'Stack version.'
    Value: '3.1.0'
  TopicName:
    Description: 'The name of the SNS topic.'
    Value: !GetAtt 'Topic.TopicName'
    Export:
      Name: !Sub '${AWS::StackName}-TopicName'
  TopicArn:
    Description: 'The ARN of the SNS topic.'
    Value: !Ref Topic
    Export:
      Name: !Sub '${AWS::StackName}-TopicArn'
